groups:
  - name: lms-backend-alerts
    rules:
      - alert: LMSApiDown
        expr: up{job=~"lms_api_.*"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "LMS API target is down"
          description: "Prometheus cannot scrape {{ $labels.job }} for at least 2 minutes."

      - alert: LMSHighErrorRate
        expr: |
          sum(rate(http_requests_total{job=~"lms_api_.*",status=~"5.."}[5m]))
          /
          clamp_min(sum(rate(http_requests_total{job=~"lms_api_.*"}[5m])), 0.001)
          > 0.05
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High 5xx error rate"
          description: "5xx rate is above 5% on {{ $labels.job }} for 10 minutes."

      - alert: LMSHighP95Latency
        expr: |
          histogram_quantile(
            0.95,
            sum(rate(http_request_duration_seconds_bucket{job=~"lms_api_.*"}[5m])) by (le, job)
          ) > 0.75
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High API latency (p95)"
          description: "p95 request latency is above 750ms on {{ $labels.job }}."

      - alert: LMSRateLimitSpike
        expr: sum(rate(http_requests_total{job=~"lms_api_.*",status="429"}[5m])) > 2
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Rate limit spike detected"
          description: "429 responses are above 2 req/s over 5m on {{ $labels.job }}."

